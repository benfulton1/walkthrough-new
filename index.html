<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#e65c00" />
  <title>Final Deficiency Walkthrough – iOS v3</title>
  <style>
    :root{ --brand:#e65c00; --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#ffffff; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --radius:16px; }
    @media (prefers-color-scheme: dark){ :root{ --bg:#0b0f17; --card:#0f1522; --ink:#e6ebf5; --muted:#94a3b8; } body{color-scheme:dark} input,select,textarea{background:#0c121e;color:var(--ink);border-color:#233044} }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg);font-size:17px}
    header{position:sticky;top:0;z-index:50;background:var(--card);border-bottom:1px solid #e5e7eb;padding:10px calc(16px + env(safe-area-inset-left))}
    .title{font-weight:800;font-size:18px}
    .sub{color:var(--muted);font-size:12px}
    main{padding:12px 16px 120px 16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .card h2{margin:0 0 8px;font-size:18px}
    .content{padding:14px}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    input,select,textarea{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:14px;background:#fff;font:inherit;min-height:44px}
    input,select{font-size:17px}
    textarea{min-height:96px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 200px}
    button{appearance:none;border:1px solid #cbd5e1;background:#fff;color:var(--ink);padding:12px 14px;border-radius:14px;font-weight:700;cursor:pointer;min-height:44px}
    button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    button:active{transform:translateY(1px)}
    details.ac{border:1px dashed #e5e7eb;border-radius:12px;padding:8px;margin:6px 0}
    details summary{cursor:pointer;font-weight:700}
    .checklist{display:grid;gap:10px;margin-top:8px}
    .check{display:flex;gap:10px;align-items:flex-start}
    .check input[type=checkbox]{width:26px;height:26px}
    .note-inline{display:none;margin-left:32px}
    .check input:checked~.note-inline{display:block}
    .room{border:1px solid #e5e7eb;border-radius:var(--radius);margin:8px 0;padding:12px;background:#fff}
    .rhead{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .thumb{width:84px;height:84px;border:1px dashed #cbd5e1;border-radius:10px;display:grid;place-items:center;overflow:hidden;background:#f9fafb}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;width:0;background:var(--brand);transition:width .3s}
    .pill{border-radius:999px;padding:4px 10px;font-size:12px;background:#eef2ff;border:1px solid #c7d2fe}
    .dock{position:fixed;left:0;right:0;bottom:0;z-index:60;background:var(--card);border-top:1px solid #e5e7eb;box-shadow:0 -6px 22px rgba(0,0,0,.08);padding:10px 16px}
    .dock .bar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media print{header,.dock{display:none} body{background:#fff} .card{break-inside:avoid}}
  </style>
</head>
<body>
  <header>
    <div class="title">Final Deficiency Walkthrough</div>
    <div class="sub">QC for new home completion • photo capture • offline save</div>
  </header>

  <main>
    <!-- Project & Client Info -->
    <section class="card"><div class="content">
      <h2>Project</h2>
      <div class="row">
        <div><label>Project Name / Lot</label><input id="project_name" placeholder="e.g., Smith – Lot 12"/></div>
        <div><label>Address</label><input id="project_address" placeholder="Street, City, Province"/></div>
      </div>
      <div class="row">
        <div><label>Final Walk Date</label><input id="walk_date" type="date"/></div>
        <div><label>Time</label><input id="walk_time" type="time"/></div>
      </div>
      <div class="row">
        <div><label>Client(s)</label><input id="client_name"/></div>
        <div><label>Site Contact</label><input id="site_contact"/></div>
      </div>
    </div></section>

    <!-- Global QC (house-wide) -->
    <section class="card"><div class="content">
      <h2>Whole‑Home QC</h2>
      <details class="ac" open>
        <summary>General Finish & Clean</summary>
        <div class="checklist" id="qc-general"></div>
      </details>
      <details class="ac" open>
        <summary>Life Safety</summary>
        <div class="checklist" id="qc-safety"></div>
      </details>
      <details class="ac">
        <summary>Mechanical / Electrical Quick Checks</summary>
        <div class="checklist" id="qc-me"></div>
      </details>
    </div></section>

    <!-- Add Room -->
    <section class="card"><div class="content">
      <h2>Add Room</h2>
      <div class="row">
        <div>
          <label>Room Type</label>
          <select id="room_type"></select>
        </div>
        <div>
          <label>Label (optional)</label>
          <input id="room_label" placeholder="e.g., Primary Ensuite, Bed 2"/>
        </div>
        <div style="align-self:end"><button id="add_room" class="primary">Add Room</button></div>
      </div>
      <p class="sub">Each room comes preloaded with a trade‑specific checklist and photo upload.</p>
    </div></section>

    <!-- Rooms list -->
    <section class="card"><div class="content">
      <h2>Rooms</h2>
      <div id="rooms"></div>
    </div></section>

    <!-- Sign-off & Progress -->
    <section class="card"><div class="content">
      <h2>Completion Progress</h2>
      <div class="progress"><span id="progress-bar"></span></div>
      <div class="row" style="margin-top:6px"><div class="pill" id="progress-label">0% complete</div></div>
    </div></section>
  </main>

  <div class="dock"><div class="bar">
    <button class="primary" id="dock-add">Add Room</button>
    <button id="dock-photo">Quick Photo</button>
    <button id="dock-save">Save</button>
    <button id="dock-clear">Clear</button>
  </div></div>

<script>
// -------- Templates for Final QC --------
const ROOMS = {
  "Kitchen": [
    'Cabinet doors/drawers aligned; soft-close working',
    'Gaps at fillers, scribes, crown ≤ 2mm; caulk neat',
    'Countertops: seams flush, overhang even, silicone at splash',
    'Appliances installed, leveled, anti-tip (range) in place',
    'Sink/faucet: no leaks; RO/soap dispensers tight',
    'GFCI protection at countertop receptacles; cover plates straight',
    'Backsplash grout complete; silicone at change-of-plane',
    'Lighting working; trims seated; dimmers labeled',
    'Paint touch-ups complete; no overspray on cabinets/fixtures'
  ],
  "Primary Bathroom": [
    'Tile flatness/lippage within tolerance; grout complete',
    'Silicone at wet joints (corners, base, niches) clean/continuous',
    'Shower pan drains; slope to drain; no pooling',
    'Glass door: sweep installed; opens/closes smoothly; reveals even',
    'Vanity: doors/drawers aligned; hardware tight',
    'Fixtures: no drips; hot/cold orientation correct',
    'Exhaust fan operates; timer/sone acceptable; exterior flap opens',
    'Heated floor (if any) tested; thermostat labeled',
    'Mirrors secure; GFCI at required locations'
  ],
  "Bathroom": [
    'Toilet set solid; caulked at base; shutoff accessible',
    'Tub/shower: caulk & grout complete; fixtures tight; no leaks',
    'Exhaust fan works; cover installed; exterior vent clear',
    'Counter/sink sealed; backsplash caulked',
    'Towel bars/hooks secure; accessories aligned',
    'Flooring transitions flush; base/quarter-round caulked'
  ],
  "Bedroom": [
    'Door latch/strike aligned; smooth swing; stop installed',
    'Closet shelving/rods secure; level; no sharp edges',
    'Windows operate & lock; screens present; stickers removed',
    'Base/casing miters tight; caulked; nail holes filled',
    'Floor free of squeaks; finish blemishes addressed',
    'Receptacles/switches labeled; cover plates straight',
    'Paint: walls/ceilings clean; no touch-up flashing'
  ],
  "Living / Dining": [
    'Drywall finish acceptable; inside/outside corners straight',
    'Ceiling fixtures centered; no wobble; lamps installed',
    'Railing/guard secure; baluster spacing compliant',
    'Fireplace surround complete; clearances per specs',
    'Floor transitions flush; reducers secure',
    'Paint/trim touch-ups complete'
  ],
  "Hall / Entry / Stairs": [
    'Handrails continuous; returns to wall; height compliant',
    'Stair treads/risers consistent; nosings aligned',
    'Closet doors track & latch properly',
    'Door hardware aligned; weatherstripping intact at exterior doors',
    'Smoke/CO locations verified per plan'
  ],
  "Laundry / Mudroom": [
    'Washer pan/drain present; valves accessible; no leaks',
    'Dryer vent connected; termination flap opens; no lint',
    'Cabinet alignment; counter support; utility sink sealed',
    'Floor slope to drain (if present); transitions flush'
  ],
  "Mechanical / Electrical Room": [
    'Furnace/boiler labeled; filter access clear; startup complete',
    'Water heater T&P discharge to approved location',
    'Panel directory complete; AFCI/GFCI breakers as required',
    'HRV/ERV balanced (label values); controls labeled',
    'Condensate lines trapped & draining; pumps wired'
  ],
  "Garage": [
    'GWB fire-taping complete at common walls/ceilings',
    'Auto-reverse on overhead doors tested; safety eyes aligned',
    'Weatherstripping continuous; threshold sealed',
    'Slope to overhead door; floor free of trip hazards',
    'GFCI outlets present; opener outlets dedicated'
  ],
  // Exterior groups
  "Exterior – Siding & Trim": [
    'Siding fasteners flush; no overdrives; joints sealed',
    'Clearances to grade/roof per manufacturer',
    'Window/door flashings & end dams visible where required',
    'Sealant at penetrations continuous; color-matched',
    'Paint/stain coverage uniform; no lap marks'
  ],
  "Exterior – Roofing & Gutters": [
    'Shingles/metal secure; ridge/valley details complete',
    'Flashing at chimneys/walls sealed; kickout flashings',
    'Gutters pitched to downspouts; seams sealed',
    'Downspouts connected; extensions/splash blocks installed'
  ],
  "Exterior – Concrete & Flatwork": [
    'Drive/paths free of spalls/chips; control joints cut',
    'Stoops/steps uniform rise/run; nosings even',
    'Garage apron transitions smooth; sealant at joints'
  ],
  "Exterior – Landscaping & Grading": [
    'Final grade slopes away 5% min. first 10 ft',
    'Topsoil/sod/seed installed as specified',
    'Irrigation heads adjusted; no overspray on house',
    'Fences/gates aligned; hardware working'
  ],
  "Decks / Patios": [
    'Ledger flashing; post bases elevated; hardware hot-dip/SS',
    'Guard height & spacing compliant; secure',
    'Decking fasteners flush; no sharp edges',
    'Stairs even rise/run; handrail secure'
  ],
  "Windows & Exterior Doors": [
    'Operable units latch/lock; weatherstripping intact',
    'Sills sealed; end dams; weep holes clear',
    'Thresholds sealed; door sweeps contact evenly',
    'Glazing clean; stickers removed; screens intact'
  ]
};

const QC_GENERAL = [
  'House broom-clean; stickers removed; protection removed',
  'Base/casing caulk lines neat; nail holes filled',
  'Paint touch-ups complete; no overspray on fixtures/floors',
  'Flooring clean & free of damage; transitions flush',
  'All doors latch; reveals even; stops installed',
  'All windows operate & lock; screens present',
  'Hardware complete; no missing caps/escutcheons'
];

const QC_SAFETY = [
  'Smoke/CO alarms installed, tested, and labeled',
  'GFCI/AFCI protections verified in required locations',
  'Tempered glazing at required areas (baths, stairs, doors)',
  'Guard/handrail heights compliant; baluster spacing',
  'Egress windows clear; openings unobstructed',
  'Combustion air/makeup air provided where required'
];

const QC_ME = [
  'Thermostats labeled; HVAC modes test heat/cool',
  'HRV/ERV running; filters installed; controls explained',
  'Plumbing: no active leaks at traps/supplies; hose bibs work',
  'Electrical: all lights/switches/receptacles functional',
  'Appliance operation check (range, DW, MW, hood)',
];

const TRADES = ['Carpentry','Drywall/Taping','Paint','Tile','Flooring','Cabinetry','Plumbing','Electrical','HVAC','Glazing','Landscaping','Concrete','Roofing','Other'];
const PRIORITY = ['Low','Medium','High','Critical'];
const STATUS = ['Open','In Progress','Resolved'];

// Populate global QC
const mkChecklist = (arr, rootId) => {
  const root = document.getElementById(rootId); root.innerHTML='';
  arr.forEach((text,i)=>{
    const id = `${rootId}-${i}`;
    const row = document.createElement('label');
    row.className='check';
    row.innerHTML = `<input type="checkbox" id="${id}"><span style="flex:1">${text}</span>
      <div class="note-inline" style="flex:1"><input placeholder="Notes"></div>`;
    root.appendChild(row);
    row.querySelector('input').addEventListener('change',updateProgress);
  })
}

function populateGlobal(){
  mkChecklist(QC_GENERAL,'qc-general');
  mkChecklist(QC_SAFETY,'qc-safety');
  mkChecklist(QC_ME,'qc-me');
}

// Room handling
const roomsEl = document.getElementById('rooms');
let roomCounter = 0;

function populateRoomTypes(){
  const sel = document.getElementById('room_type'); sel.innerHTML='';
  Object.keys(ROOMS).forEach(k=>{ const o=document.createElement('option'); o.textContent=k; sel.appendChild(o); });
}

function addRoom(){
  const type = document.getElementById('room_type').value;
  const label = document.getElementById('room_label').value.trim();
  const name = label? `${type} — ${label}` : type;
  const id = `room-${++roomCounter}`;
  const items = ROOMS[type]||['General review','Finish quality','Function tests'];

  const el = document.createElement('div'); el.className='room'; el.id=id;
  el.innerHTML = `
    <div class="rhead">
      <strong>${name}</strong>
      <div style="display:flex;gap:8px;flex-wrap:nowrap">
        <button class="btn-add-def">Add Deficiency</button>
        <button class="btn-photo">Photo</button>
        <button class="btn-remove" style="color:#dc2626">Remove</button>
      </div>
    </div>
    <details class="ac" open>
      <summary>Checklist</summary>
      <div class="checklist room-check"></div>
    </details>
    <div>
      <label>Photos</label>
      <div class="thumbs"></div>
    </div>
    <div>
      <label>Deficiencies</label>
      <div class="defs"></div>
    </div>`;

  const rc = el.querySelector('.room-check');
  items.forEach((txt,i)=>{
    const cid = `${id}-chk-${i}`;
    const row = document.createElement('label'); row.className='check';
    row.innerHTML = `<input type="checkbox" id="${cid}"><span style="flex:1">${txt}</span>
      <div class="note-inline" style="flex:1"><input placeholder="Notes"></div>`;
    rc.appendChild(row);
    row.querySelector('input').addEventListener('change',updateProgress);
  });

  el.querySelector('.btn-remove').addEventListener('click',()=>{ el.remove(); updateProgress(); saveDraft(); });
  el.querySelector('.btn-add-def').addEventListener('click',()=> addDef(el));
  el.querySelector('.btn-photo').addEventListener('click',()=> quickPhoto(el.querySelector('.thumbs')));

  roomsEl.appendChild(el);
  updateProgress(); saveDraft();
}

function addDef(container){
  const defs = container.querySelector('.defs');
  const def = document.createElement('div');
  def.style.border='1px solid #e5e7eb'; def.style.borderRadius='12px'; def.style.padding='10px'; def.style.margin='8px 0'; def.style.display='grid'; def.style.gap='10px';
  def.innerHTML = `
    <div class="row">
      <div><label>Description</label><input class="d-desc" placeholder="What needs fixing?"/></div>
    </div>
    <div class="row">
      <div><label>Trade</label><select class="d-trade">${TRADES.map(t=>`<option>${t}</option>`).join('')}</select></div>
      <div><label>Priority</label><select class="d-prio">${PRIORITY.map(p=>`<option>${p}</option>`).join('')}</select></div>
      <div><label>Status</label><select class="d-status">${STATUS.map(s=>`<option>${s}</option>`).join('')}</select></div>
    </div>
    <div class="row">
      <div><label>Due Date</label><input type="date" class="d-due"/></div>
      <div><label>Location (within room)</label><input class="d-loc" placeholder="e.g., north wall, vanity left"/></div>
    </div>
    <div><label>Notes</label><textarea class="d-notes" placeholder="Any context"></textarea></div>
    <div class="row">
      <div><label>Attach Photo</label><input type="file" accept="image/*" capture="environment" class="d-file"/><div class="thumbs"></div></div>
      <div style="align-self:end;margin-left:auto"><button class="d-remove" style="color:#dc2626">Remove</button></div>
    </div>`;

  // photo preview
  def.querySelector('.d-file').addEventListener('change',function(){
    const holder = def.querySelector('.thumbs');
    [...this.files].forEach(f=>{ const r=new FileReader(); r.onload=e=>{ const t=document.createElement('div'); t.className='thumb'; t.innerHTML=`<img src="${e.target.result}" alt="photo"/>`; holder.appendChild(t); saveDraft(); }; r.readAsDataURL(f); });
  });

  def.querySelector('.d-remove').addEventListener('click',()=>{ def.remove(); updateProgress(); saveDraft(); });
  def.querySelector('.d-status').addEventListener('change',updateProgress);

  defs.appendChild(def); saveDraft();
}

function quickPhoto(target){
  const input = document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment';
  input.addEventListener('change', function(){
    if(!target){ target = document.querySelector('#rooms .thumbs') || document.createElement('div'); }
    [...this.files].forEach(f=>{ const r=new FileReader(); r.onload=e=>{ const t=document.createElement('div'); t.className='thumb'; t.innerHTML=`<img src="${e.target.result}">`; target.appendChild(t); saveDraft(); }; r.readAsDataURL(f); });
  });
  input.click();
}

// Progress calc (checks + resolved deficiencies)
function updateProgress(){
  const checks = document.querySelectorAll('input[type=checkbox]');
  const total = checks.length; const done = [...checks].filter(c=>c.checked).length;
  const statuses = document.querySelectorAll('.d-status'); let resolved=0, sCount=0; statuses.forEach(s=>{sCount++; if(s.value==='Resolved') resolved++;});
  const pct = Math.round(((total?done/total:0)*0.6 + (sCount?resolved/sCount:0)*0.4)*100);
  document.getElementById('progress-bar').style.width = pct + '%';
  document.getElementById('progress-label').textContent = pct + '% complete';
}

// Save / Load
const KEY='final_def_walkthrough_v3';
function collect(){ return { rooms: roomsEl.innerHTML, qcGen: document.getElementById('qc-general').innerHTML, qcSaf: document.getElementById('qc-safety').innerHTML, qcME: document.getElementById('qc-me').innerHTML, project: {name:val('project_name'),addr:val('project_address'),date:val('walk_date'),time:val('walk_time'),client:val('client_name'),contact:val('site_contact')} }; }
function populate(data){ if(!data) return; roomsEl.innerHTML = data.rooms||''; document.getElementById('qc-general').innerHTML = data.qcGen||''; document.getElementById('qc-safety').innerHTML = data.qcSaf||''; document.getElementById('qc-me').innerHTML = data.qcME||''; const p=data.project||{}; setVal('project_name',p.name); setVal('project_address',p.addr); setVal('walk_date',p.date); setVal('walk_time',p.time); setVal('client_name',p.client); setVal('site_contact',p.contact); rebindDynamic(); updateProgress(); }
function saveDraft(){ localStorage.setItem(KEY, JSON.stringify(collect())); }
function loadDraft(){ const raw = localStorage.getItem(KEY); if(!raw) return; try{ populate(JSON.parse(raw)); }catch(e){ console.warn(e); }}
function clearDraft(){ localStorage.removeItem(KEY); location.reload(); }
function val(id){ const el=document.getElementById(id); return el?el.value:''; }
function setVal(id,v){ const el=document.getElementById(id); if(el) el.value=v||''; }

function rebindDynamic(){
  document.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.addEventListener('change',updateProgress));
  document.querySelectorAll('.room .btn-remove').forEach(b=>b.addEventListener('click',e=>{ e.currentTarget.closest('.room').remove(); updateProgress(); saveDraft(); }));
  document.querySelectorAll('.room .btn-add-def').forEach(b=>b.addEventListener('click',e=> addDef(e.currentTarget.closest('.room'))));
  document.querySelectorAll('.room .btn-photo').forEach(b=>b.addEventListener('click',e=> quickPhoto(e.currentTarget.closest('.room').querySelector('.thumbs'))));
  document.querySelectorAll('.d-remove').forEach(b=>b.addEventListener('click',e=>{ const d=e.currentTarget.closest('div[style]'); d.remove(); updateProgress(); saveDraft(); }));
  document.querySelectorAll('.d-status').forEach(s=>s.addEventListener('change',updateProgress));
}

// Init
populateGlobal();
populateRoomTypes();
document.getElementById('add_room').addEventListener('click',addRoom);
document.getElementById('dock-add').addEventListener('click',addRoom);
document.getElementById('dock-photo').addEventListener('click',()=> quickPhoto());
document.getElementById('dock-save').addEventListener('click',()=>{ saveDraft(); alert('Saved on this device'); });
document.getElementById('dock-clear').addEventListener('click',()=>{ if(confirm('Clear all data?')) clearDraft(); });

setInterval(()=>{ try{ saveDraft(); }catch(e){} }, 5000);
loadDraft();
</script>
</body>
</html>
